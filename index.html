<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Shop - Интернет магазин</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --primary-light: #34495e;
      --secondary: #e74c3c;
      --success: #27ae60;
      --warning: #f39c12;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --gray: #7f8c8d;
      --gray-light: #bdc3c7;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
      --radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header Styles */
    header {
      background: white;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
    }

    .logo i {
      color: var(--secondary);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .balance {
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      border-radius: var(--radius);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .balance i {
      color: var(--success);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      opacity: 0.9;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    /* Main Content */
    .main-content {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 30px;
      padding: 30px 0;
    }

    /* Categories Sidebar */
    .categories-sidebar {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      height: fit-content;
      box-shadow: var(--shadow);
    }

    .categories-sidebar h3 {
      margin-bottom: 15px;
      color: var(--primary);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray-light);
    }

    .category-list {
      list-style: none;
    }

    .category-item {
      padding: 12px 15px;
      margin: 5px 0;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .category-item:hover {
      background: var(--light);
      transform: translateX(5px);
    }

    .category-item.active {
      background: var(--primary);
      color: white;
    }

    .category-count {
      background: var(--gray-light);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
    }

    .category-item.active .category-count {
      background: rgba(255,255,255,0.3);
    }

    /* Products Grid */
    .products-section {
      flex: 1;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
    }

    .product-card {
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      position: relative;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }

    .product-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--secondary);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .product-image {
      height: 200px;
      background: linear-gradient(45deg, var(--light), var(--gray-light));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray);
    }

    .product-image i {
      font-size: 4rem;
    }

    .product-info {
      padding: 20px;
    }

    .product-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--dark);
    }

    .product-description {
      color: var(--gray);
      font-size: 0.9rem;
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .product-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .product-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--gray-light);
    }

    .product-stock {
      color: var(--success);
      font-weight: 600;
    }

    .product-stock.out-of-stock {
      color: var(--danger);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1001;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--gray-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-light);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    /* Admin Panel */
    .admin-panel {
      background: white;
      border-radius: var(--radius);
      padding: 30px;
      margin-top: 30px;
      box-shadow: var(--shadow);
    }

    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--gray-light);
      padding-bottom: 10px;
    }

    .admin-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-radius: var(--radius) var(--radius) 0 0;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray);
    }

    .admin-tab.active {
      background: var(--primary);
      color: white;
    }

    .admin-section {
      display: none;
    }

    .admin-section.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--light);
      padding: 20px;
      border-radius: var(--radius);
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin: 10px 0;
    }

    .stat-label {
      color: var(--gray);
      font-size: 0.9rem;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--radius);
      color: white;
      font-weight: 600;
      z-index: 1002;
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.warning {
      background: var(--warning);
    }

    /* Responsive Design */
    @media (max-width: 992px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .categories-sidebar {
        display: none;
      }
      
      .mobile-categories {
        display: block;
        margin-bottom: 20px;
      }
    }

    @media (max-width: 768px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .user-info {
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 0 10px;
      }
      
      .products-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .mb-20 {
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }

    .loading i {
      font-size: 2rem;
      margin-bottom: 10px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-content">
        <a href="#" class="logo">
          <i class="fas fa-shopping-cart"></i>
          <span>SHOP</span>
        </a>
        <div class="user-info">
          <div class="balance" id="balanceDisplay">
            <i class="fas fa-wallet"></i>
            <span>Баланс: <span id="balance">0</span>₴</span>
          </div>
          <button class="btn btn-outline btn-sm" onclick="showAuthModal()">
            <i class="fas fa-user"></i>
            <span id="authBtnText">Войти</span>
          </button>
          <button class="btn btn-secondary btn-sm hidden" id="logoutBtn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Выйти
          </button>
          <button class="btn btn-primary btn-sm" onclick="toggleAdminPanel()">
            <i class="fas fa-cog"></i>
            Админка
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <div class="main-content">
      <!-- Categories Sidebar -->
      <aside class="categories-sidebar">
        <h3><i class="fas fa-list"></i> Категории</h3>
        <ul class="category-list" id="categoryList">
          <li class="category-item active" data-category="all">
            <span>Все товары</span>
            <span class="category-count" id="allCount">0</span>
          </li>
          <!-- Categories will be loaded here -->
        </ul>
      </aside>

      <!-- Products Section -->
      <main class="products-section">
        <h2 class="mb-20">Товары</h2>
        <div class="products-grid" id="productsGrid">
          <!-- Products will be loaded here -->
        </div>
      </main>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel hidden" id="adminPanel">
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchAdminTab('stats')">
          <i class="fas fa-chart-bar"></i> Статистика
        </button>
        <button class="admin-tab" onclick="switchAdminTab('users')">
          <i class="fas fa-users"></i> Пользователи
        </button>
        <button class="admin-tab" onclick="switchAdminTab('categories')">
          <i class="fas fa-tags"></i> Категории
        </button>
        <button class="admin-tab" onclick="switchAdminTab('products')">
          <i class="fas fa-box"></i> Товары
        </button>
      </div>

      <!-- Stats Tab -->
      <div id="statsTab" class="admin-section active">
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-users fa-2x"></i>
            <div class="stat-value" id="totalUsers">0</div>
            <div class="stat-label">Пользователей</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-box fa-2x"></i>
            <div class="stat-value" id="totalProducts">0</div>
            <div class="stat-label">Товаров</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-shopping-cart fa-2x"></i>
            <div class="stat-value" id="totalSales">0</div>
            <div class="stat-label">Продаж</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-coins fa-2x"></i>
            <div class="stat-value" id="totalRevenue">0</div>
            <div class="stat-label">Выручка</div>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="usersTab" class="admin-section">
        <h3>Управление пользователями</h3>
        <div class="form-group">
          <label>Поиск пользователя:</label>
          <input type="text" class="form-control" id="userSearch" placeholder="Введите имя пользователя..." oninput="searchUsers()">
        </div>
        <div id="usersList" class="mt-20">
          <!-- Users list will be loaded here -->
        </div>
      </div>

      <!-- Categories Tab -->
      <div id="categoriesTab" class="admin-section">
        <h3>Управление категориями</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Название категории:</label>
            <input type="text" class="form-control" id="categoryName">
          </div>
          <div class="form-group">
            <label>Действие:</label>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-primary" onclick="createCategory()">
                <i class="fas fa-plus"></i> Создать
              </button>
              <button class="btn btn-danger" onclick="deleteCategory()">
                <i class="fas fa-trash"></i> Удалить
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Products Tab -->
      <div id="productsTab" class="admin-section">
        <h3>Управление товарами</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Категория:</label>
            <select class="form-control" id="productCategory">
              <!-- Options will be loaded here -->
            </select>
          </div>
          <div class="form-group">
            <label>Название товара:</label>
            <input type="text" class="form-control" id="productName">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Цена (₴):</label>
            <input type="number" class="form-control" id="productPrice" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label>Количество:</label>
            <input type="number" class="form-control" id="productStock" min="0">
          </div>
        </div>
        <div class="form-group">
          <label>Описание:</label>
          <textarea class="form-control" id="productDesc" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Характеристики (JSON):</label>
          <textarea class="form-control" id="productSpecs" rows="4" placeholder='{"цвет": "черный", "вес": "1.5кг"}'></textarea>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="saveProduct()">
            <i class="fas fa-save"></i> Сохранить товар
          </button>
          <button class="btn btn-danger" onclick="deleteProduct()">
            <i class="fas fa-trash"></i> Удалить товар
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Вход / Регистрация</h3>
        <button class="close-modal" onclick="closeAuthModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Имя пользователя:</label>
          <input type="text" class="form-control" id="authUsername" placeholder="Введите имя пользователя">
        </div>
        <div class="form-group">
          <label>Пароль:</label>
          <input type="password" class="form-control" id="authPassword" placeholder="Введите пароль">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn btn-primary" onclick="login()" style="flex: 1;">
            <i class="fas fa-sign-in-alt"></i> Войти
          </button>
          <button class="btn btn-secondary" onclick="register()" style="flex: 1;">
            <i class="fas fa-user-plus"></i> Зарегистрироваться
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalProductTitle"></h3>
        <button class="close-modal" onclick="closeProductModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="product-price" id="modalProductPrice"></div>
        <p id="modalProductDescription"></p>
        <h4>Характеристики:</h4>
        <pre id="modalProductSpecs"></pre>
        <div class="product-meta">
          <div id="modalProductStock"></div>
          <button class="btn btn-primary" onclick="buyProduct()">
            <i class="fas fa-shopping-cart"></i> Купить
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <script>
    let storeData = {
      users: {},
      categories: {},
      sales: []
    };
    let currentUser = null;
    let currentProduct = null;
    let selectedCategory = 'all';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      checkSavedUser();
      setupEventListeners();
    });

    // Event Listeners
    function setupEventListeners() {
      document.getElementById('authPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') login();
      });
    }

    // Load data from server
    async function loadData() {
      try {
        showLoading();
        const res = await fetch('/get_data');
        if (!res.ok) throw new Error('Server error');
        storeData = await res.json();
        updateUI();
      } catch (error) {
        showNotification('Ошибка загрузки данных', 'error');
        console.error('Load error:', error);
      } finally {
        hideLoading();
      }
    }

    // Save data to server
    async function saveData() {
      try {
        await fetch('/save_data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(storeData)
        });
      } catch (error) {
        console.error('Save error:', error);
      }
    }

    // Update UI
    function updateUI() {
      updateCategories();
      updateProducts();
      updateBalance();
      updateStats();
      updateAdminSelects();
    }

    // Update categories
    function updateCategories() {
      const categoryList = document.getElementById('categoryList');
      const categories = Object.keys(storeData.categories || {});
      
      // Clear except "All"
      const allItem = categoryList.querySelector('[data-category="all"]');
      categoryList.innerHTML = '';
      categoryList.appendChild(allItem);
      
      // Update "All" count
      let totalProducts = 0;
      categories.forEach(cat => {
        totalProducts += Object.keys(storeData.categories[cat] || {}).length;
      });
      document.getElementById('allCount').textContent = totalProducts;
      
      // Add categories
      categories.forEach(cat => {
        const productCount = Object.keys(storeData.categories[cat] || {}).length;
        const li = document.createElement('li');
        li.className = 'category-item';
        li.dataset.category = cat;
        li.innerHTML = `
          <span>${cat}</span>
          <span class="category-count">${productCount}</span>
        `;
        li.onclick = () => selectCategory(cat);
        categoryList.appendChild(li);
      });
    }

    // Update products
    function updateProducts() {
      const productsGrid = document.getElementById('productsGrid');
      productsGrid.innerHTML = '';
      
      let products = [];
      if (selectedCategory === 'all') {
        Object.values(storeData.categories || {}).forEach(category => {
          Object.entries(category || {}).forEach(([name, product]) => {
            products.push({ category: Object.keys(storeData.categories).find(cat => storeData.categories[cat] === category), name, ...product });
          });
        });
      } else {
        const category = storeData.categories[selectedCategory];
        if (category) {
          Object.entries(category).forEach(([name, product]) => {
            products.push({ category: selectedCategory, name, ...product });
          });
        }
      }
      
      if (products.length === 0) {
        productsGrid.innerHTML = '<div class="text-center" style="grid-column: 1/-1; padding: 40px;"><i class="fas fa-box-open fa-3x"></i><p style="margin-top: 20px;">Товаров не найдено</p></div>';
        return;
      }
      
      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          ${product.stock < 5 ? '<div class="product-badge">Мало осталось!</div>' : ''}
          <div class="product-image">
            <i class="fas fa-box"></i>
          </div>
          <div class="product-info">
            <h4 class="product-title">${product.name}</h4>
            <p class="product-description">${product.description || 'Описание отсутствует'}</p>
            <div class="product-price">${product.price}₴</div>
            <div class="product-meta">
              <div class="product-stock ${product.stock === 0 ? 'out-of-stock' : ''}">
                ${product.stock === 0 ? 'Нет в наличии' : `В наличии: ${product.stock}`}
              </div>
              <button class="btn btn-sm btn-primary" onclick="showProductModal('${product.category}', '${product.name}')">
                <i class="fas fa-eye"></i> Подробнее
              </button>
            </div>
          </div>
        `;
        productsGrid.appendChild(card);
      });
    }

    // Update balance display
    function updateBalance() {
      if (currentUser && storeData.users[currentUser]) {
        document.getElementById('balance').textContent = storeData.users[currentUser].balance;
        document.getElementById('authBtnText').textContent = currentUser;
        document.getElementById('logoutBtn').classList.remove('hidden');
        document.querySelector('#authModal + .btn-outline').classList.add('hidden');
      } else {
        document.getElementById('balance').textContent = '0';
        document.getElementById('authBtnText').textContent = 'Войти';
        document.getElementById('logoutBtn').classList.add('hidden');
        document.querySelector('#authModal + .btn-outline').classList.remove('hidden');
      }
    }

    // Update statistics
    function updateStats() {
      const users = Object.keys(storeData.users || {}).length;
      let products = 0;
      let revenue = 0;
      
      Object.values(storeData.categories || {}).forEach(category => {
        products += Object.keys(category || {}).length;
        Object.values(category || {}).forEach(product => {
          revenue += product.price * (product.sold || 0);
        });
      });
      
      document.getElementById('totalUsers').textContent = users;
      document.getElementById('totalProducts').textContent = products;
      document.getElementById('totalSales').textContent = storeData.sales?.length || 0;
      document.getElementById('totalRevenue').textContent = revenue + '₴';
    }

    // Authentication functions
    function showAuthModal() {
      document.getElementById('authModal').classList.add('active');
    }

    function closeAuthModal() {
      document.getElementById('authModal').classList.remove('active');
    }

    async function register() {
      const username = document.getElementById('authUsername').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      
      if (!username || !password) {
        showNotification('Заполните все поля', 'warning');
        return;
      }
      
      if (storeData.users[username]) {
        showNotification('Пользователь уже существует', 'error');
        return;
      }
      
      storeData.users[username] = {
        balance: 1000, // Starting balance
        password: password,
        createdAt: new Date().toISOString()
      };
      
      currentUser = username;
      localStorage.setItem('currentUser', username);
      await saveData();
      closeAuthModal();
      updateUI();
      showNotification('Регистрация успешна!', 'success');
    }

    function login() {
      const username = document.getElementById('authUsername').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      
      if (!storeData.users[username] || storeData.users[username].password !== password) {
        showNotification('Неверные данные', 'error');
        return;
      }
      
      currentUser = username;
      localStorage.setItem('currentUser', username);
      closeAuthModal();
      updateUI();
      showNotification('Вход выполнен', 'success');
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      updateUI();
      showNotification('Вы вышли из системы', 'warning');
    }

    function checkSavedUser() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser && storeData.users[savedUser]) {
        currentUser = savedUser;
        updateUI();
      }
    }

    // Product functions
    function showProductModal(category, productName) {
      const product = storeData.categories[category]?.[productName];
      if (!product) return;
      
      currentProduct = { category, name: productName };
      document.getElementById('modalProductTitle').textContent = productName;
      document.getElementById('modalProductPrice').textContent = `${product.price}₴`;
      document.getElementById('modalProductDescription').textContent = product.description || 'Описание отсутствует';
      document.getElementById('modalProductSpecs').textContent = JSON.stringify(product.specs || {}, null, 2);
      document.getElementById('modalProductStock').innerHTML = `
        <span class="product-stock ${product.stock === 0 ? 'out-of-stock' : ''}">
          ${product.stock === 0 ? 'Нет в наличии' : `В наличии: ${product.stock}`}
        </span>
      `;
      
      document.getElementById('productModal').classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('active');
      currentProduct = null;
    }

    async function buyProduct() {
      if (!currentUser) {
        showNotification('Сначала войдите в систему', 'warning');
        return;
      }
      
      if (!currentProduct) return;
      
      const { category, name } = currentProduct;
      const product = storeData.categories[category]?.[name];
      const user = storeData.users[currentUser];
      
      if (!product || product.stock === 0) {
        showNotification('Товар закончился', 'error');
        return;
      }
      
      if (user.balance < product.price) {
        showNotification('Недостаточно средств', 'error');
        return;
      }
      
      // Process purchase
      user.balance -= product.price;
      product.stock -= 1;
      product.sold = (product.sold || 0) + 1;
      
      // Record sale
      storeData.sales = storeData.sales || [];
      storeData.sales.push({
        user: currentUser,
        product: name,
        category: category,
        price: product.price,
        date: new Date().toISOString()
      });
      
      await saveData();
      updateUI();
      showNotification(`Покупка успешна! Куплен ${name}`, 'success');
      closeProductModal();
    }

    // Admin functions
    function toggleAdminPanel() {
      const panel = document.getElementById('adminPanel');
      panel.classList.toggle('hidden');
    }

    function switchAdminTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${tabName}Tab`).classList.add('active');
      
      // Load data for specific tab
      if (tabName === 'users') {
        loadUsersList();
      }
    }

    function updateAdminSelects() {
      const categorySelect = document.getElementById('productCategory');
      categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
      
      Object.keys(storeData.categories || {}).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
    }

    async function createCategory() {
      const name = document.getElementById('categoryName').value.trim();
      if (!name) {
        showNotification('Введите название категории', 'warning');
        return;
      }
      
      if (storeData.categories[name]) {
        showNotification('Категория уже существует', 'warning');
        return;
      }
      
      storeData.categories[name] = {};
      await saveData();
      updateUI();
      showNotification('Категория создана', 'success');
    }

    async function deleteCategory() {
      const name = document.getElementById('categoryName').value.trim();
      if (!storeData.categories[name]) {
        showNotification('Категория не найдена', 'error');
        return;
      }
      
      if (confirm(`Удалить категорию "${name}" и все товары в ней?`)) {
        delete storeData.categories[name];
        await saveData();
        updateUI();
        showNotification('Категория удалена', 'success');
      }
    }

    async function saveProduct() {
      const category = document.getElementById('productCategory').value.trim();
      const name = document.getElementById('productName').value.trim();
      const price = parseFloat(document.getElementById('productPrice').value);
      const stock = parseInt(document.getElementById('productStock').value);
      const description = document.getElementById('productDesc').value.trim();
      const specsText = document.getElementById('productSpecs').value.trim();
      
      if (!category || !name || isNaN(price) || isNaN(stock)) {
        showNotification('Заполните все обязательные поля', 'warning');
        return;
      }
      
      let specs = {};
      if (specsText) {
        try {
          specs = JSON.parse(specsText);
        } catch (e) {
          showNotification('Ошибка в формате характеристик JSON', 'error');
          return;
        }
      }
      
      if (!storeData.categories[category]) {
        storeData.categories[category] = {};
      }
      
      storeData.categories[category][name] = {
        price,
        stock,
        description,
        specs,
        updatedAt: new Date().toISOString()
      };
      
      await saveData();
      updateUI();
      showNotification('Товар сохранен', 'success');
      clearProductForm();
    }

    async function deleteProduct() {
      const category = document.getElementById('productCategory').value.trim();
      const name = document.getElementById('productName').value.trim();
      
      if (!storeData.categories[category]?.[name]) {
        showNotification('Товар не найден', 'error');
        return;
      }
      
      if (confirm(`Удалить товар "${name}" из категории "${category}"?`)) {
        delete storeData.categories[category][name];
        
        // Remove empty category
        if (Object.keys(storeData.categories[category]).length === 0) {
          delete storeData.categories[category];
        }
        
        await saveData();
        updateUI();
        showNotification('Товар удален', 'success');
        clearProductForm();
      }
    }

    function clearProductForm() {
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productStock').value = '';
      document.getElementById('productDesc').value = '';
      document.getElementById('productSpecs').value = '';
    }

    function loadUsersList() {
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '';
      
      Object.entries(storeData.users || {}).forEach(([username, user]) => {
        const div = document.createElement('div');
        div.className = 'user-card';
        div.style.cssText = 'background: var(--light); padding: 15px; border-radius: var(--radius); margin-bottom: 10px;';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${username}</strong>
              <div style="color: var(--gray); font-size: 0.9rem;">
                Баланс: ${user.balance}₴
                ${user.createdAt ? `· Регистрация: ${new Date(user.createdAt).toLocaleDateString()}` : ''}
              </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="number" id="balanceInput_${username}" placeholder="Сумма" style="width: 100px; padding: 5px;">
              <button class="btn btn-sm btn-primary" onclick="updateUserBalance('${username}')">
                <i class="fas fa-plus"></i> Добавить
              </button>
            </div>
          </div>
        `;
        usersList.appendChild(div);
      });
    }

    async function updateUserBalance(username) {
      const input = document.getElementById(`balanceInput_${username}`);
      const amount = parseFloat(input.value);
      
      if (isNaN(amount) || amount === 0) {
        showNotification('Введите корректную сумму', 'warning');
        return;
      }
      
      storeData.users[username].balance += amount;
      await saveData();
      updateUI();
      showNotification(`Баланс пользователя ${username} обновлен`, 'success');
      input.value = '';
    }

    function searchUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      document.querySelectorAll('.user-card').forEach(card => {
        const username = card.querySelector('strong').textContent.toLowerCase();
        card.style.display = username.includes(searchTerm) ? '' : 'none';
      });
    }

    function selectCategory(category) {
      selectedCategory = category;
      document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('active');
      updateProducts();
    }

    // Utility functions
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
      `;
      
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function showLoading() {
      const productsGrid = document.getElementById('productsGrid');
      productsGrid.innerHTML = `
        <div class="loading" style="grid-column: 1/-1;">
          <i class="fas fa-spinner"></i>
          <p>Загрузка...</p>
        </div>
      `;
    }

    function hideLoading() {
      // Loading is replaced by updateProducts()
    }
  </script>
</body>
</html>
