<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Shop</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial;background:#f5f5f5}
header{background:#2c3e50;color:white;padding:15px}
.header{display:flex;justify-content:space-between}
.balance{background:#34495e;padding:5px 15px;border-radius:20px}
.btn{padding:8px 16px;border:none;border-radius:4px;cursor:pointer}
.btn-primary{background:#3498db;color:white}
.btn-secondary{background:#e74c3c;color:white}
.container{max-width:1200px;margin:auto;padding:20px}
.tabs{display:flex;gap:10px;margin-bottom:20px}
.tab{padding:8px 16px;background:#ecf0f1;border:none;border-radius:4px;cursor:pointer}
.tab.active{background:#3498db;color:white}
.tab-content{display:none}
.tab-content.active{display:block}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}
.product{background:white;border-radius:5px;padding:15px}
.order{background:#f8f9fa;border:1px solid #dee2e6;border-radius:5px;padding:15px;margin-bottom:10px}
.hidden{display:none}
</style>
</head>
<body>
<header>
<div class="container">
<div class="header">
<div>SHOP</div>
<div>
<span class="balance">Баланс: <span id="balance">0</span>₴</span>
<button class="btn" onclick="showTab('auth')" id="authBtn">Войти</button>
<button class="btn btn-secondary hidden" onclick="logout()" id="logoutBtn">Выйти</button>
<button class="btn btn-primary" onclick="toggleAdmin()">Админка</button>
</div>
</div>
</div>
</header>

<div class="container">
<div class="tabs">
<button class="tab" onclick="showTab('auth')">Вход</button>
<button class="tab" onclick="showTab('products')">Товары</button>
<button class="tab" onclick="showTab('orders')">Мои заказы</button>
</div>

<div id="authTab" class="tab-content active">
<input type="text" id="user" placeholder="Имя" value="user1"><br><br>
<input type="password" id="pass" placeholder="Пароль" value="pass1"><br><br>
<button class="btn btn-primary" onclick="login()">Войти</button>
<button class="btn btn-secondary" onclick="register()">Регистрация</button>
</div>

<div id="productsTab" class="tab-content">
<div id="products"></div>
</div>

<div id="ordersTab" class="tab-content">
<div id="myOrders"></div>
</div>

<div id="adminPanel" class="tab-content hidden">
<div class="tabs">
<button class="tab active" onclick="adminTab('adminOrders')">Заказы</button>
<button class="tab" onclick="adminTab('adminProducts')">Товары</button>
<button class="tab" onclick="adminTab('adminUsers')">Пользователи</button>
</div>
<div id="adminOrders" class="tab-content active"></div>
<div id="adminProducts" class="tab-content">
<input type="text" id="cat" placeholder="Категория"><br>
<input type="text" id="prodName" placeholder="Название"><br>
<input type="number" id="price" placeholder="Цена"><br>
<input type="number" id="stock" placeholder="Количество"><br>
<button class="btn btn-primary" onclick="addProduct()">Добавить</button>
<button class="btn btn-secondary" onclick="removeProduct()">Удалить</button>
</div>
<div id="adminUsers" class="tab-content">
<input type="text" id="searchUser" placeholder="Имя пользователя"><br>
<input type="number" id="addBalance" placeholder="Сумма"><br>
<button class="btn btn-primary" onclick="changeBalance()">Изм.баланс</button>
</div>
</div>
</div>

<script>
let storeData = {users:{},categories:{},orders:[],adminPass:"log21"};
let currentUser = null;
let isAdmin = false;

async function loadData(){
const res = await fetch('/get_data');
storeData = await res.json();
if(!storeData.adminPass) storeData.adminPass="log21";
updateUI();
}

async function saveData(){
await fetch('/save_data',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify(storeData)
});
}

function updateUI(){
updateProducts();
updateOrders();
updateBalance();
}

function updateProducts(){
const div = document.getElementById('products');
div.innerHTML='';
for(let cat in storeData.categories){
for(let prod in storeData.categories[cat]){
let p = storeData.categories[cat][prod];
div.innerHTML+=`
<div class="product">
<h3>${prod}</h3>
<p>Цена: ${p.price}₴</p>
<p>В наличии: ${p.stock}</p>
<button class="btn btn-primary" onclick="buy('${cat}','${prod}')">Купить</button>
</div>`;
}}
}

function updateOrders(){
const div = document.getElementById('myOrders');
div.innerHTML='';
if(!currentUser) return;
let userOrders = storeData.orders.filter(o=>o.user===currentUser);
userOrders.forEach(o=>{
let status = o.status||'ожидает';
div.innerHTML+=`
<div class="order">
<p>${o.product} - ${o.price}₴</p>
<p>Статус: ${status}</p>
${status==='ожидает'?`<button class="btn btn-secondary" onclick="cancelOrder('${o.id}')">Отменить</button>`:''}
</div>`;
});
}

function updateBalance(){
if(currentUser && storeData.users[currentUser]){
document.getElementById('balance').textContent=storeData.users[currentUser].balance;
document.getElementById('authBtn').classList.add('hidden');
document.getElementById('logoutBtn').classList.remove('hidden');
}else{
document.getElementById('balance').textContent='0';
document.getElementById('authBtn').classList.remove('hidden');
document.getElementById('logoutBtn').classList.add('hidden');
}
}

function showTab(tab){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(t=>t.classList.add('hidden'));
event.target.classList.add('active');
document.getElementById(tab+'Tab').classList.remove('hidden');
if(tab==='orders') updateOrders();
}

function login(){
let user=document.getElementById('user').value;
let pass=document.getElementById('pass').value;
if(user==='admin'&&pass===storeData.adminPass){
currentUser='admin';isAdmin=true;
showTab('products');updateUI();
alert('Админ вошел');
return;
}
if(storeData.users[user]&&storeData.users[user].password===pass){
currentUser=user;isAdmin=false;
showTab('products');updateUI();
}else alert('Неверно');
}

function register(){
let user=document.getElementById('user').value;
let pass=document.getElementById('pass').value;
if(!storeData.users[user]){
storeData.users[user]={balance:1000,password:pass};
currentUser=user;
saveData();
showTab('products');updateUI();
alert('Регистрация успешна');
}else alert('Уже есть');
}

function logout(){
currentUser=null;isAdmin=false;
showTab('auth');updateUI();
}

async function buy(cat,prod){
if(!currentUser){alert('Войдите');return;}
let user=storeData.users[currentUser];
let product=storeData.categories[cat][prod];
if(user.balance>=product.price&&product.stock>0){
user.balance-=product.price;
product.stock--;
let order={
id:Date.now().toString(),
user:currentUser,
product:prod,
category:cat,
price:product.price,
status:'ожидает',
createdAt:new Date().toISOString()
};
storeData.orders.push(order);
await saveData();
updateUI();
alert('Куплено');
}else alert('Нельзя купить');
}

async function cancelOrder(id){
let order=storeData.orders.find(o=>o.id===id);
if(order&&order.user===currentUser&&order.status==='ожидает'){
order.status='отменен';
let user=storeData.users[currentUser];
if(user)user.balance+=order.price;
if(storeData.categories[order.category]&&storeData.categories[order.category][order.product]){
storeData.categories[order.category][order.product].stock++;
}
await saveData();
updateUI();
}
}

function toggleAdmin(){
if(!isAdmin){
let pass=prompt('Пароль админа:');
if(pass===storeData.adminPass){
isAdmin=true;
document.getElementById('adminPanel').classList.remove('hidden');
showAdminOrders();
}else alert('Неверно');
}else{
document.getElementById('adminPanel').classList.toggle('hidden');
}
}

function adminTab(tab){
document.querySelectorAll('#adminPanel .tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('#adminPanel .tab-content').forEach(t=>t.classList.add('hidden'));
event.target.classList.add('active');
document.getElementById(tab).classList.remove('hidden');
}

function showAdminOrders(){
let div=document.getElementById('adminOrders');
div.innerHTML='';
storeData.orders.forEach((o,i)=>{
div.innerHTML+=`
<div class="order">
<p>${o.user}: ${o.product} - ${o.price}₴</p>
<p>Статус: ${o.status||'ожидает'}</p>
<button class="btn" onclick="changeOrderStatus('${o.id}','выполнен')">Выполнен</button>
<button class="btn" onclick="changeOrderStatus('${o.id}','отменен')">Отменить</button>
</div>`;
});
}

async function changeOrderStatus(id,status){
let order=storeData.orders.find(o=>o.id===id);
if(order){
let old=order.status||'ожидает';
order.status=status;
if(old==='ожидает'&&status==='отменен'){
let user=storeData.users[order.user];
if(user)user.balance+=order.price;
if(storeData.categories[order.category]&&storeData.categories[order.category][order.product]){
storeData.categories[order.category][order.product].stock++;
}
}
await saveData();
showAdminOrders();
}
}

async function addProduct(){
let cat=document.getElementById('cat').value;
let name=document.getElementById('prodName').value;
let price=parseFloat(document.getElementById('price').value);
let stock=parseInt(document.getElementById('stock').value);
if(cat&&name&&price&&stock){
if(!storeData.categories[cat])storeData.categories[cat]={};
storeData.categories[cat][name]={price,stock};
await saveData();
updateProducts();
alert('Добавлен');
}
}

async function removeProduct(){
let cat=document.getElementById('cat').value;
let name=document.getElementById('prodName').value;
if(storeData.categories[cat]&&storeData.categories[cat][name]){
delete storeData.categories[cat][name];
await saveData();
updateProducts();
alert('Удален');
}
}

async function changeBalance(){
let user=document.getElementById('searchUser').value;
let amount=parseFloat(document.getElementById('addBalance').value);
if(storeData.users[user]&&!isNaN(amount)){
storeData.users[user].balance+=amount;
await saveData();
alert('Баланс изменен');
}
}

loadData();
</script>
</body>
</html>