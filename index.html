<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; }
    
    header { background: #2c3e50; color: white; padding: 15px 20px; }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.5rem; font-weight: bold; }
    .user-info { display: flex; gap: 15px; align-items: center; }
    .balance { background: #34495e; padding: 5px 15px; border-radius: 20px; }
    
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #3498db; color: white; }
    .btn-secondary { background: #e74c3c; color: white; }
    .btn-outline { background: transparent; border: 2px solid #3498db; color: #3498db; }
    .btn-success { background: #27ae60; color: white; }
    .btn-warning { background: #f39c12; color: white; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    .categories { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .category-btn { padding: 8px 16px; background: white; border: none; border-radius: 4px; cursor: pointer; }
    .category-btn.active { background: #3498db; color: white; }
    
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .product-card { background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .product-img { height: 150px; background: #ecf0f1; display: flex; align-items: center; justify-content: center; color: #7f8c8d; }
    .product-info { padding: 15px; }
    .product-price { font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin: 10px 0; }
    .product-stock { color: #27ae60; font-size: 0.9rem; }
    .product-stock.out { color: #e74c3c; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 5px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    .modal-body { padding: 15px; }
    
    .form-group { margin-bottom: 15px; }
    .form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    
    .admin-panel { background: white; padding: 20px; border-radius: 5px; margin-top: 20px; display: none; }
    .admin-panel.active { display: block; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { padding: 8px 16px; background: #ecf0f1; border: none; border-radius: 4px; cursor: pointer; }
    .tab.active { background: #3498db; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .order-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 10px; }
    .order-status { padding: 3px 10px; border-radius: 3px; font-size: 0.9rem; display: inline-block; margin-top: 5px; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    
    .hidden { display: none !important; }
    .mt-20 { margin-top: 20px; }
    .mb-10 { margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">SHOP</div>
        <div class="user-info">
          <div class="balance">–ë–∞–ª–∞–Ω—Å: <span id="balance">0</span>‚Ç¥</div>
          <button class="btn btn-outline" onclick="showTab('auth')" id="authBtn">–í–æ–π—Ç–∏</button>
          <button class="btn btn-secondary hidden" onclick="logout()" id="logoutBtn">–í—ã–π—Ç–∏</button>
          <button class="btn btn-primary" onclick="toggleAdmin()" id="adminBtn">–ê–¥–º–∏–Ω–∫–∞</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Auth Tab -->
    <div id="authTab" class="tab-content active">
      <div class="form-group">
        <input type="text" class="form-control" id="authUser" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" value="user1">
      </div>
      <div class="form-group">
        <input type="password" class="form-control" id="authPass" placeholder="–ü–∞—Ä–æ–ª—å" value="pass1">
      </div>
      <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
      <button class="btn btn-secondary" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
    
    <!-- Products Tab -->
    <div id="productsTab" class="tab-content hidden">
      <div class="categories">
        <button class="category-btn active" onclick="selectCategory('all')">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
        <div id="categoryList"></div>
      </div>
      <div class="products-grid" id="productsGrid"></div>
    </div>
    
    <!-- Orders Tab -->
    <div id="ordersTab" class="tab-content hidden">
      <h3>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
      <div id="userOrders"></div>
    </div>
    
    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
      <div class="tabs">
        <button class="tab active" onclick="switchAdminTab('adminOrders')">–ó–∞–∫–∞–∑—ã</button>
        <button class="tab" onclick="switchAdminTab('adminProducts')">–¢–æ–≤–∞—Ä—ã</button>
        <button class="tab" onclick="switchAdminTab('adminUsers')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
        <button class="tab" onclick="switchAdminTab('adminSettings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
      
      <!-- Admin Orders -->
      <div id="adminOrders" class="tab-content active">
        <div id="allOrders"></div>
      </div>
      
      <!-- Admin Products -->
      <div id="adminProducts" class="tab-content">
        <div class="form-group">
          <select class="form-control" id="productCategory">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
          </select>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" id="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        </div>
        <div class="form-group">
          <input type="number" class="form-control" id="productPrice" placeholder="–¶–µ–Ω–∞">
        </div>
        <div class="form-group">
          <input type="number" class="form-control" id="productStock" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
        </div>
        <div class="form-group">
          <textarea class="form-control" id="productDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        </div>
        <button class="btn btn-primary" onclick="saveProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-secondary" onclick="deleteProduct()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      
      <!-- Admin Users -->
      <div id="adminUsers" class="tab-content">
        <div class="form-group">
          <input type="text" class="form-control" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        </div>
        <div id="usersList"></div>
      </div>
      
      <!-- Admin Settings -->
      <div id="adminSettings" class="tab-content">
        <div class="form-group">
          <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:</label>
          <input type="password" class="form-control" id="newAdminPass" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
        </div>
        <button class="btn btn-primary" onclick="changeAdminPass()">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button onclick="closeProductModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="product-price" id="modalPrice"></div>
        <p id="modalDesc"></p>
        <p class="product-stock" id="modalStock"></p>
        <button class="btn btn-primary mt-20" onclick="buyProduct()" id="buyBtn">–ö—É–ø–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    let storeData = {
      users: {},
      categories: {},
      orders: [],
      adminPass: "log21"
    };
    
    let currentUser = null;
    let currentProduct = null;
    let selectedCategory = 'all';
    let isAdmin = false;

    // Load data
    async function loadData() {
      const res = await fetch('/get_data');
      storeData = await res.json();
      if (!storeData.adminPass) storeData.adminPass = "log21";
      updateUI();
    }

    // Save data
    async function saveData() {
      await fetch('/save_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(storeData)
      });
    }

    // Update UI
    function updateUI() {
      updateCategories();
      updateProducts();
      updateBalance();
      if (currentUser) {
        updateUserOrders();
      }
      if (isAdmin) {
        updateAdminOrders();
      }
    }

    // Update categories
    function updateCategories() {
      const list = document.getElementById('categoryList');
      list.innerHTML = '';
      Object.keys(storeData.categories || {}).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.textContent = cat;
        btn.onclick = () => selectCategory(cat);
        list.appendChild(btn);
      });
      
      const select = document.getElementById('productCategory');
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
      Object.keys(storeData.categories || {}).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    // Update products
    function updateProducts() {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      
      let products = [];
      if (selectedCategory === 'all') {
        Object.entries(storeData.categories || {}).forEach(([catName, cat]) => {
          Object.entries(cat).forEach(([prodName, product]) => {
            products.push({ category: catName, name: prodName, ...product });
          });
        });
      } else {
        const cat = storeData.categories[selectedCategory];
        if (cat) {
          Object.entries(cat).forEach(([prodName, product]) => {
            products.push({ category: selectedCategory, name: prodName, ...product });
          });
        }
      }
      
      if (products.length === 0) {
        grid.innerHTML = '<p>–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç</p>';
        return;
      }
      
      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <div class="product-img">
            <div style="font-size: 2rem;">üì¶</div>
          </div>
          <div class="product-info">
            <h4>${product.name}</h4>
            <div class="product-price">${product.price}‚Ç¥</div>
            <p class="product-stock ${product.stock === 0 ? 'out' : ''}">
              ${product.stock === 0 ? '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' : `–í –Ω–∞–ª–∏—á–∏–∏: ${product.stock}`}
            </p>
            <button class="btn btn-primary" onclick="showProduct('${product.category}', '${product.name}')">
              –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // Update balance
    function updateBalance() {
      const balanceEl = document.getElementById('balance');
      const authBtn = document.getElementById('authBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      
      if (currentUser && storeData.users[currentUser]) {
        balanceEl.textContent = storeData.users[currentUser].balance;
        authBtn.textContent = currentUser;
        authBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
      } else {
        balanceEl.textContent = '0';
        authBtn.textContent = '–í–æ–π—Ç–∏';
        authBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
      }
    }

    // Update user orders
    function updateUserOrders() {
      const container = document.getElementById('userOrders');
      if (!container) return;
      
      container.innerHTML = '';
      
      const userOrders = (storeData.orders || []).filter(order => order.user === currentUser);
      
      if (userOrders.length === 0) {
        container.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>';
        return;
      }
      
      // Sort by date
      userOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      userOrders.forEach((order, index) => {
        const card = document.createElement('div');
        card.className = 'order-card';
        
        let statusClass = 'status-pending';
        let statusText = '–û–∂–∏–¥–∞–µ—Ç';
        if (order.status === 'completed') {
          statusClass = 'status-completed';
          statusText = '–í—ã–ø–æ–ª–Ω–µ–Ω';
        } else if (order.status === 'cancelled') {
          statusClass = 'status-cancelled';
          statusText = '–û—Ç–º–µ–Ω–µ–Ω';
        }
        
        card.innerHTML = `
          <div>
            <strong>${order.product}</strong><br>
            <small>${new Date(order.createdAt).toLocaleString()}</small><br>
            <span class="order-status ${statusClass}">${statusText}</span>
          </div>
          <p>–¶–µ–Ω–∞: ${order.price}‚Ç¥</p>
          ${order.status === 'pending' ? `
            <button class="btn btn-secondary btn-sm" onclick="cancelOrder('${order.id}')">
              –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
          ` : ''}
        `;
        container.appendChild(card);
      });
    }

    // Update admin orders
    function updateAdminOrders() {
      const container = document.getElementById('allOrders');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!storeData.orders || storeData.orders.length === 0) {
        container.innerHTML = '<p>–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</p>';
        return;
      }
      
      // Sort by date
      const sortedOrders = [...storeData.orders].sort((a, b) => 
        new Date(b.createdAt) - new Date(a.createdAt)
      );
      
      sortedOrders.forEach((order, index) => {
        const card = document.createElement('div');
        card.className = 'order-card';
        
        let statusClass = 'status-pending';
        let statusText = '–û–∂–∏–¥–∞–µ—Ç';
        if (order.status === 'completed') {
          statusClass = 'status-completed';
          statusText = '–í—ã–ø–æ–ª–Ω–µ–Ω';
        } else if (order.status === 'cancelled') {
          statusClass = 'status-cancelled';
          statusText = '–û—Ç–º–µ–Ω–µ–Ω';
        }
        
        card.innerHTML = `
          <div>
            <strong>–ó–∞–∫–∞–∑ #${index + 1}</strong><br>
            <small>${new Date(order.createdAt).toLocaleString()}</small><br>
            <span class="order-status ${statusClass}">${statusText}</span>
          </div>
          <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${order.user}</p>
          <p><strong>–¢–æ–≤–∞—Ä:</strong> ${order.product}</p>
          <p><strong>–¶–µ–Ω–∞:</strong> ${order.price}‚Ç¥</p>
          <div class="mt-20">
            ${order.status === 'pending' ? `
              <button class="btn btn-success btn-sm" onclick="completeOrder('${order.id}')">
                ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω
              </button>
              <button class="btn btn-secondary btn-sm" onclick="adminCancelOrder('${order.id}')">
                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
              </button>
            ` : ''}
            ${order.status === 'completed' ? `
              <button class="btn btn-warning btn-sm" onclick="pendingOrder('${order.id}')">
                ‚Ü© –í –æ–∂–∏–¥–∞–Ω–∏–µ
              </button>
            ` : ''}
            ${order.status === 'cancelled' ? `
              <button class="btn btn-warning btn-sm" onclick="pendingOrder('${order.id}')">
                ‚Ü© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
              </button>
            ` : ''}
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Auth functions
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
    }

    async function register() {
      const user = document.getElementById('authUser').value.trim();
      const pass = document.getElementById('authPass').value.trim();
      
      if (!user || !pass) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }
      
      if (storeData.users[user]) {
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        return;
      }
      
      storeData.users[user] = { 
        balance: 1000, 
        password: pass,
        createdAt: new Date().toISOString()
      };
      
      currentUser = user;
      await saveData();
      showTab('products');
      updateUI();
      alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ù–∞ —Å—á–µ—Ç—É 1000‚Ç¥');
    }

    function login() {
      const user = document.getElementById('authUser').value.trim();
      const pass = document.getElementById('authPass').value.trim();
      
      // Check if admin
      if (user === 'admin' && pass === storeData.adminPass) {
        currentUser = 'admin';
        isAdmin = true;
        showTab('products');
        updateUI();
        alert('–í—Ö–æ–¥ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
        return;
      }
      
      // Check regular user
      if (storeData.users[user] && storeData.users[user].password === pass) {
        currentUser = user;
        isAdmin = false;
        showTab('products');
        updateUI();
        alert('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω');
      } else {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
      }
    }

    function logout() {
      currentUser = null;
      isAdmin = false;
      showTab('auth');
      updateUI();
    }

    // Product functions
    function selectCategory(category) {
      selectedCategory = category;
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      updateProducts();
    }

    function showProduct(category, productName) {
      if (!storeData.categories[category] || !storeData.categories[category][productName]) {
        alert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      currentProduct = { category, name: productName };
      const product = storeData.categories[category][productName];
      
      document.getElementById('modalTitle').textContent = productName;
      document.getElementById('modalPrice').textContent = `${product.price}‚Ç¥`;
      document.getElementById('modalDesc').textContent = product.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
      document.getElementById('modalStock').textContent = product.stock === 0 ? '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' : `–í –Ω–∞–ª–∏—á–∏–∏: ${product.stock} —à—Ç.`;
      
      const buyBtn = document.getElementById('buyBtn');
      if (product.stock === 0) {
        buyBtn.disabled = true;
        buyBtn.textContent = '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
      } else {
        buyBtn.disabled = false;
        buyBtn.textContent = '–ö—É–ø–∏—Ç—å';
      }
      
      document.getElementById('productModal').classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('active');
      currentProduct = null;
    }

    async function buyProduct() {
      if (!currentUser) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }
      
      if (!currentProduct) return;
      
      const { category, name } = currentProduct;
      const product = storeData.categories[category][name];
      const user = storeData.users[currentUser];
      
      if (!product || product.stock === 0) {
        alert('–¢–æ–≤–∞—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');
        return;
      }
      
      if (user.balance < product.price) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
        return;
      }
      
      // Process purchase
      user.balance -= product.price;
      product.stock -= 1;
      
      // Create order
      if (!storeData.orders) {
        storeData.orders = [];
      }
      
      const order = {
        id: Date.now().toString(),
        user: currentUser,
        product: name,
        category: category,
        price: product.price,
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      
      storeData.orders.push(order);
      
      await saveData();
      updateUI();
      alert('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!');
      closeProductModal();
      showTab('orders');
    }

    // Order functions
    async function cancelOrder(orderId) {
      const order = storeData.orders.find(o => o.id === orderId);
      
      if (!order || order.user !== currentUser) {
        alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      if (order.status !== 'pending') {
        alert('–ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã');
        return;
      }
      
      // Return money
      const user = storeData.users[currentUser];
      if (user) {
        user.balance += order.price;
      }
      
      // Return product to stock
      if (storeData.categories[order.category] && storeData.categories[order.category][order.product]) {
        storeData.categories[order.category][order.product].stock += 1;
      }
      
      order.status = 'cancelled';
      
      await saveData();
      updateUI();
      alert('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω');
    }

    // Admin functions
    function toggleAdmin() {
      if (!isAdmin) {
        const pass = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:');
        if (pass === storeData.adminPass) {
          isAdmin = true;
          currentUser = 'admin';
          updateUI();
          document.getElementById('adminPanel').classList.toggle('active');
        } else {
          alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        }
      } else {
        document.getElementById('adminPanel').classList.toggle('active');
      }
    }

    function switchAdminTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
      
      if (tabName === 'adminUsers') {
        loadUsersList();
      }
    }

    async function completeOrder(orderId) {
      const order = storeData.orders.find(o => o.id === orderId);
      if (order) {
        order.status = 'completed';
        await saveData();
        updateAdminOrders();
      }
    }

    async function adminCancelOrder(orderId) {
      const order = storeData.orders.find(o => o.id === orderId);
      if (order) {
        order.status = 'cancelled';
        
        // Return money
        const user = storeData.users[order.user];
        if (user) {
          user.balance += order.price;
        }
        
        // Return product
        if (storeData.categories[order.category] && storeData.categories[order.category][order.product]) {
          storeData.categories[order.category][order.product].stock += 1;
        }
        
        await saveData();
        updateAdminOrders();
      }
    }

    async function pendingOrder(orderId) {
      const order = storeData.orders.find(o => o.id === orderId);
      if (order) {
        order.status = 'pending';
        await saveData();
        updateAdminOrders();
      }
    }

    async function saveProduct() {
      const cat = document.getElementById('productCategory').value.trim();
      const name = document.getElementById('productName').value.trim();
      const price = parseFloat(document.getElementById('productPrice').value);
      const stock = parseInt(document.getElementById('productStock').value);
      const desc = document.getElementById('productDesc').value.trim();
      
      if (!cat || !name || isNaN(price) || isNaN(stock)) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }
      
      if (!storeData.categories[cat]) {
        storeData.categories[cat] = {};
      }
      
      storeData.categories[cat][name] = {
        price: price,
        stock: stock,
        description: desc,
        specs: {}
      };
      
      await saveData();
      updateUI();
      alert('–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
    }

    async function deleteProduct() {
      const cat = document.getElementById('productCategory').value.trim();
      const name = document.getElementById('productName').value.trim();
      
      if (storeData.categories[cat] && storeData.categories[cat][name]) {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${name}"?`)) {
          delete storeData.categories[cat][name];
          await saveData();
          updateUI();
          alert('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω');
        }
      } else {
        alert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }
    }

    function loadUsersList() {
      const list = document.getElementById('usersList');
      list.innerHTML = '';
      
      Object.entries(storeData.users || {}).forEach(([username, data]) => {
        const div = document.createElement('div');
        div.style.cssText = 'background: #ecf0f1; padding: 15px; margin: 10px 0; border-radius: 4px;';
        div.innerHTML = `
          <strong>${username}</strong><br>
          <small>–ë–∞–ª–∞–Ω—Å: ${data.balance}‚Ç¥</small>
          <div style="margin-top: 10px;">
            <input type="number" id="amt_${username}" placeholder="–°—É–º–º–∞" style="width: 100px; padding: 5px;">
            <button class="btn btn-sm btn-primary" onclick="addBalance('${username}')">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    async function addBalance(username) {
      const input = document.getElementById(`amt_${username}`);
      const amount = parseFloat(input.value);
      
      if (isNaN(amount)) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
        return;
      }
      
      storeData.users[username].balance += amount;
      await saveData();
      updateUI();
      alert(`–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω`);
      input.value = '';
    }

    async function changeAdminPass() {
      const newPass = document.getElementById('newAdminPass').value;
      
      if (!newPass) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å');
        return;
      }
      
      storeData.adminPass = newPass;
      await saveData();
      alert('–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω');
      document.getElementById('newAdminPass').value = '';
    }

    // Initialize
    loadData();
  </script>
</body>
</html>
