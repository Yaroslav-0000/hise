<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; }
    
    /* Header */
    header { background: #2c3e50; color: white; padding: 15px 20px; }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.5rem; font-weight: bold; }
    .user-info { display: flex; gap: 15px; align-items: center; }
    .balance { background: #34495e; padding: 5px 15px; border-radius: 20px; }
    
    /* Buttons */
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #3498db; color: white; }
    .btn-secondary { background: #e74c3c; color: white; }
    .btn-outline { background: transparent; border: 2px solid #3498db; color: #3498db; }
    
    /* Main */
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .main-content { display: flex; gap: 20px; margin-top: 20px; }
    
    /* Categories */
    .categories { width: 200px; background: white; padding: 15px; border-radius: 5px; }
    .category-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    .category-item.active { background: #3498db; color: white; }
    
    /* Products */
    .products-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .product-card { background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .product-img { height: 150px; background: #ecf0f1; display: flex; align-items: center; justify-content: center; color: #7f8c8d; }
    .product-info { padding: 15px; }
    .product-price { font-size: 1.2rem; font-weight: bold; color: #2c3e50; margin: 10px 0; }
    .product-stock { color: #27ae60; font-size: 0.9rem; }
    
    /* Modals */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 5px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    .modal-body { padding: 15px; }
    
    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    
    /* Admin */
    .admin-panel { background: white; padding: 20px; border-radius: 5px; margin-top: 20px; }
    .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .admin-tab { padding: 8px 16px; background: #ecf0f1; border: none; border-radius: 4px; cursor: pointer; }
    .admin-tab.active { background: #3498db; color: white; }
    .admin-section { display: none; }
    .admin-section.active { display: block; }
    
    /* Utility */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-20 { margin-top: 20px; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">SHOP</div>
        <div class="user-info">
          <div class="balance">Баланс: <span id="balance">0</span>₴</div>
          <button class="btn btn-outline" onclick="showAuthModal()" id="authBtn">Войти</button>
          <button class="btn btn-secondary hidden" onclick="logout()" id="logoutBtn">Выйти</button>
          <button class="btn btn-primary" onclick="toggleAdmin()">Админ</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <div class="main-content">
      <!-- Categories -->
      <div class="categories">
        <div class="category-item active" onclick="selectCategory('all')">Все товары</div>
        <div id="categoryList"></div>
      </div>
      
      <!-- Products -->
      <div class="products-grid" id="productsGrid"></div>
    </div>
    
    <!-- Admin Panel -->
    <div class="admin-panel hidden" id="adminPanel">
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('products')">Товары</button>
        <button class="admin-tab" onclick="switchTab('categories')">Категории</button>
        <button class="admin-tab" onclick="switchTab('users')">Пользователи</button>
      </div>
      
      <!-- Products Tab -->
      <div id="productsTab" class="admin-section active">
        <div class="form-group">
          <select class="form-control" id="productCategory">
            <option value="">Выберите категорию</option>
          </select>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" id="productName" placeholder="Название товара">
        </div>
        <div class="form-group">
          <input type="number" class="form-control" id="productPrice" placeholder="Цена">
        </div>
        <div class="form-group">
          <input type="number" class="form-control" id="productStock" placeholder="Количество">
        </div>
        <div class="form-group">
          <textarea class="form-control" id="productDesc" placeholder="Описание"></textarea>
        </div>
        <button class="btn btn-primary" onclick="saveProduct()">Сохранить</button>
        <button class="btn btn-secondary" onclick="deleteProduct()">Удалить</button>
      </div>
      
      <!-- Categories Tab -->
      <div id="categoriesTab" class="admin-section">
        <div class="form-group">
          <input type="text" class="form-control" id="categoryName" placeholder="Название категории">
        </div>
        <button class="btn btn-primary" onclick="createCategory()">Создать</button>
        <button class="btn btn-secondary" onclick="deleteCategory()">Удалить</button>
      </div>
      
      <!-- Users Tab -->
      <div id="usersTab" class="admin-section">
        <div class="form-group">
          <input type="text" class="form-control" id="userSearch" placeholder="Поиск пользователя">
        </div>
        <div id="usersList"></div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Вход / Регистрация</h3>
        <button onclick="closeAuthModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <input type="text" class="form-control" id="authUser" placeholder="Имя пользователя">
        </div>
        <div class="form-group">
          <input type="password" class="form-control" id="authPass" placeholder="Пароль">
        </div>
        <button class="btn btn-primary" onclick="login()">Войти</button>
        <button class="btn btn-secondary" onclick="register()">Регистрация</button>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button onclick="closeProductModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="product-price" id="modalPrice"></div>
        <p id="modalDesc"></p>
        <p class="product-stock" id="modalStock"></p>
        <button class="btn btn-primary mt-20" onclick="buyProduct()">Купить</button>
      </div>
    </div>
  </div>

  <script>
    let storeData = { users: {}, categories: {} };
    let currentUser = null;
    let currentProduct = null;
    let selectedCategory = 'all';

    // Load data
    async function loadData() {
      try {
        const res = await fetch('/get_data');
        storeData = await res.json();
        updateUI();
      } catch(e) {
        console.error('Ошибка загрузки:', e);
      }
    }

    // Save data
    async function saveData() {
      await fetch('/save_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(storeData)
      });
    }

    // Update UI
    function updateUI() {
      updateCategories();
      updateProducts();
      updateBalance();
    }

    // Update categories
    function updateCategories() {
      const list = document.getElementById('categoryList');
      list.innerHTML = '';
      Object.keys(storeData.categories || {}).forEach(cat => {
        const div = document.createElement('div');
        div.className = 'category-item';
        div.textContent = cat;
        div.onclick = () => selectCategory(cat);
        list.appendChild(div);
      });
      
      // Update admin select
      const select = document.getElementById('productCategory');
      select.innerHTML = '<option value="">Выберите категорию</option>';
      Object.keys(storeData.categories || {}).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    // Update products
    function updateProducts() {
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      
      let products = [];
      if (selectedCategory === 'all') {
        Object.values(storeData.categories || {}).forEach(cat => {
          Object.entries(cat).forEach(([name, product]) => {
            products.push({ name, ...product });
          });
        });
      } else {
        const cat = storeData.categories[selectedCategory];
        if (cat) {
          Object.entries(cat).forEach(([name, product]) => {
            products.push({ name, ...product });
          });
        }
      }
      
      products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <div class="product-img">
            <i class="fas fa-box"></i>
          </div>
          <div class="product-info">
            <h4>${product.name}</h4>
            <div class="product-price">${product.price}₴</div>
            <p class="product-stock">В наличии: ${product.stock}</p>
            <button class="btn btn-primary" onclick="showProduct('${product.name}')">Подробнее</button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // Update balance
    function updateBalance() {
      const balanceEl = document.getElementById('balance');
      const authBtn = document.getElementById('authBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      
      if (currentUser && storeData.users[currentUser]) {
        balanceEl.textContent = storeData.users[currentUser].balance;
        authBtn.textContent = currentUser;
        authBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
      } else {
        balanceEl.textContent = '0';
        authBtn.textContent = 'Войти';
        authBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
      }
    }

    // Auth functions
    function showAuthModal() {
      document.getElementById('authModal').classList.add('active');
    }

    function closeAuthModal() {
      document.getElementById('authModal').classList.remove('active');
    }

    async function register() {
      const user = document.getElementById('authUser').value;
      const pass = document.getElementById('authPass').value;
      
      if (!user || !pass) {
        alert('Заполните все поля');
        return;
      }
      
      if (storeData.users[user]) {
        alert('Пользователь уже существует');
        return;
      }
      
      storeData.users[user] = { balance: 1000, password: pass };
      currentUser = user;
      localStorage.setItem('currentUser', user);
      await saveData();
      closeAuthModal();
      updateUI();
      alert('Регистрация успешна');
    }

    function login() {
      const user = document.getElementById('authUser').value;
      const pass = document.getElementById('authPass').value;
      
      if (storeData.users[user] && storeData.users[user].password === pass) {
        currentUser = user;
        localStorage.setItem('currentUser', user);
        closeAuthModal();
        updateUI();
        alert('Вход успешен');
      } else {
        alert('Неверные данные');
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      updateUI();
    }

    // Product functions
    function showProduct(productName) {
      // Find product in any category
      for (const cat in storeData.categories) {
        if (storeData.categories[cat][productName]) {
          currentProduct = { category: cat, name: productName };
          const product = storeData.categories[cat][productName];
          
          document.getElementById('modalTitle').textContent = productName;
          document.getElementById('modalPrice').textContent = `${product.price}₴`;
          document.getElementById('modalDesc').textContent = product.description || 'Описание отсутствует';
          document.getElementById('modalStock').textContent = `В наличии: ${product.stock}`;
          
          document.getElementById('productModal').classList.add('active');
          break;
        }
      }
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('active');
      currentProduct = null;
    }

    async function buyProduct() {
      if (!currentUser) {
        alert('Сначала войдите');
        return;
      }
      
      if (!currentProduct) return;
      
      const { category, name } = currentProduct;
      const product = storeData.categories[category][name];
      const user = storeData.users[currentUser];
      
      if (user.balance >= product.price && product.stock > 0) {
        user.balance -= product.price;
        product.stock -= 1;
        await saveData();
        updateUI();
        alert('Покупка успешна');
        closeProductModal();
      } else {
        alert('Недостаточно средств или товара нет');
      }
    }

    // Admin functions
    function toggleAdmin() {
      document.getElementById('adminPanel').classList.toggle('hidden');
    }

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.admin-section').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.admin-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + 'Tab').classList.add('active');
      event.target.classList.add('active');
      
      // Load users if needed
      if (tabName === 'users') {
        loadUsersList();
      }
    }

    async function createCategory() {
      const name = document.getElementById('categoryName').value;
      if (!name) {
        alert('Введите название');
        return;
      }
      
      if (!storeData.categories[name]) {
        storeData.categories[name] = {};
        await saveData();
        updateUI();
        alert('Категория создана');
      } else {
        alert('Категория уже существует');
      }
    }

    async function deleteCategory() {
      const name = document.getElementById('categoryName').value;
      if (storeData.categories[name]) {
        if (confirm(`Удалить категорию "${name}"?`)) {
          delete storeData.categories[name];
          await saveData();
          updateUI();
          alert('Категория удалена');
        }
      } else {
        alert('Категория не найдена');
      }
    }

    async function saveProduct() {
      const cat = document.getElementById('productCategory').value;
      const name = document.getElementById('productName').value;
      const price = parseFloat(document.getElementById('productPrice').value);
      const stock = parseInt(document.getElementById('productStock').value);
      const desc = document.getElementById('productDesc').value;
      
      if (!cat || !name || isNaN(price) || isNaN(stock)) {
        alert('Заполните все поля');
        return;
      }
      
      if (!storeData.categories[cat]) {
        storeData.categories[cat] = {};
      }
      
      storeData.categories[cat][name] = {
        price: price,
        stock: stock,
        description: desc
      };
      
      await saveData();
      updateUI();
      alert('Товар сохранен');
    }

    async function deleteProduct() {
      const cat = document.getElementById('productCategory').value;
      const name = document.getElementById('productName').value;
      
      if (storeData.categories[cat] && storeData.categories[cat][name]) {
        if (confirm(`Удалить товар "${name}"?`)) {
          delete storeData.categories[cat][name];
          if (Object.keys(storeData.categories[cat]).length === 0) {
            delete storeData.categories[cat];
          }
          await saveData();
          updateUI();
          alert('Товар удален');
        }
      } else {
        alert('Товар не найден');
      }
    }

    function loadUsersList() {
      const list = document.getElementById('usersList');
      list.innerHTML = '';
      
      Object.entries(storeData.users || {}).forEach(([user, data]) => {
        const div = document.createElement('div');
        div.style.cssText = 'background: #ecf0f1; padding: 10px; margin: 5px 0; border-radius: 4px;';
        div.innerHTML = `
          <strong>${user}</strong> (${data.balance}₴)
          <input type="number" id="amt_${user}" placeholder="Сумма" style="width: 80px; margin-left: 10px;">
          <button onclick="addBalance('${user}')" style="padding: 4px 8px; margin-left: 5px;">+</button>
        `;
        list.appendChild(div);
      });
    }

    async function addBalance(username) {
      const input = document.getElementById(`amt_${username}`);
      const amount = parseFloat(input.value);
      
      if (isNaN(amount)) {
        alert('Введите сумму');
        return;
      }
      
      storeData.users[username].balance += amount;
      await saveData();
      updateUI();
      alert('Баланс обновлен');
      input.value = '';
    }

    function selectCategory(category) {
      selectedCategory = category;
      document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.classList.add('active');
      updateProducts();
    }

    // Initialize
    loadData();
    
    // Check saved user
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      currentUser = savedUser;
      updateUI();
    }
  </script>
</body>
</html>