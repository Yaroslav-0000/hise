<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Магазин</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1, h2 { text-align: center; }
    .hidden { display: none; }
    .product, .category { border: 1px solid #ccc; background: #fff; padding: 10px; margin: 10px; }
    button { margin: 5px; padding: 5px 10px; }
    input, textarea { margin: 5px; padding: 5px; width: 90%; }
    #products { display: flex; flex-wrap: wrap; justify-content: center; }
    #products .product { width: 250px; }
    #loginPanel, #adminPanel { margin: 20px; padding: 10px; background: #eee; }
  </style>
</head>
<body>
  <h1>Магазин</h1>

  <!-- Панель входа -->
  <div id="loginPanel">
    <h2>Вход</h2>
    <input id="loginUser" placeholder="Имя пользователя">
    <input id="loginPass" type="password" placeholder="Пароль">
    <button onclick="register()">Регистрация</button>
    <button onclick="login()">Войти</button>
  </div>

  <h2>Баланс: <span id="balance">0</span>₴</h2>
  <div id="products"></div>

  <button onclick="showAdmin()">Админка</button>

  <!-- Админка -->
  <div id="adminPanel" class="hidden">
    <h2>Админка</h2>
    <label>Пароль: <input type="password" id="adminPass"></label>
    <button onclick="loginAdmin()">Войти</button>

    <div id="adminActions" class="hidden">
      <h3>Управление балансами</h3>
      <input id="userName" placeholder="Имя пользователя">
      <input id="amount" type="number" placeholder="Сумма">
      <button onclick="updateBalance()">Добавить к балансу</button>

      <h3>Управление категориями</h3>
      <input id="categoryName" placeholder="Категория">
      <button onclick="createCategory()">Создать категорию</button>
      <button onclick="deleteCategory()">Удалить категорию</button>

      <h3>Управление товарами</h3>
      <input id="productName" placeholder="Название товара">
      <input id="productPrice" type="number" placeholder="Цена">
      <input id="productStock" type="number" placeholder="В наличии">
      <textarea id="productDesc" placeholder="Описание"></textarea>
      <textarea id="productSpecs" placeholder='Характеристики (JSON)'></textarea>
      <button onclick="addProduct()">Добавить/Обновить товар</button>
      <button onclick="deleteProduct()">Удалить товар</button>
    </div>
  </div>

  <script>
    let storeData = {};
    let currentUser = null;

    async function loadData() {
      const res = await fetch("/get_data");
      storeData = await res.json();
      if (currentUser && storeData.users[currentUser]) {
        document.getElementById("balance").textContent = storeData.users[currentUser].balance;
      }
      renderProducts();
    }

    function renderProducts() {
      const container = document.getElementById("products");
      container.innerHTML = "";
      for (const [catName, products] of Object.entries(storeData.categories || {})) {
        const catDiv = document.createElement("div");
        catDiv.className = "category";
        catDiv.innerHTML = `<h3>Категория: ${catName}</h3>`;
        for (const [prodName, prod] of Object.entries(products)) {
          const div = document.createElement("div");
          div.className = "product";
          div.innerHTML = `
            <h4>${prodName}</h4>
            <p><b>Цена:</b> ${prod.price}₴</p>
            <p><b>В наличии:</b> ${prod.stock}</p>
            <p>${prod.description}</p>
            <pre>${JSON.stringify(prod.specs, null, 2)}</pre>
            <button onclick="buyProduct('${catName}','${prodName}')">Купить</button>
          `;
          catDiv.appendChild(div);
        }
        container.appendChild(catDiv);
      }
    }

    async function buyProduct(cat, prod) {
      if (!currentUser) { alert("Сначала войдите!"); return; }
      const userBalance = storeData.users[currentUser].balance;
      const product = storeData.categories[cat][prod];
      if (userBalance >= product.price && product.stock > 0) {
        storeData.users[currentUser].balance -= product.price;
        product.stock -= 1;
        await saveData();
        alert("Покупка успешна!");
        loadData();
      } else {
        alert("Недостаточно средств или товара нет в наличии!");
      }
    }

    function register() {
      const user = document.getElementById("loginUser").value;
      const pass = document.getElementById("loginPass").value;
      if (!storeData.users[user]) {
        storeData.users[user] = { balance: 0, password: pass };
        currentUser = user;
        saveData();
        alert("Регистрация успешна!");
        loadData();
      } else {
        alert("Пользователь уже существует!");
      }
    }

    function login() {
      const user = document.getElementById("loginUser").value;
      const pass = document.getElementById("loginPass").value;
      if (storeData.users[user] && storeData.users[user].password === pass) {
        currentUser = user;
        alert("Вход успешен!");
        loadData();
      } else {
        alert("Неверные данные!");
      }
    }

    function showAdmin() {
      document.getElementById("adminPanel").classList.remove("hidden");
    }

    function loginAdmin() {
      const pass = document.getElementById("adminPass").value;
      if (pass === "log21") {
        document.getElementById("adminActions").classList.remove("hidden");
      } else {
        alert("Неверный пароль");
      }
    }

    async function updateBalance() {
      const user = document.getElementById("userName").value;
      const amount = parseInt(document.getElementById("amount").value);
      if (!storeData.users[user]) storeData.users[user] = { balance: 0, password: "" };
      storeData.users[user].balance += amount;
      await saveData();
      alert("Баланс обновлён");
      loadData();
    }

    async function createCategory() {
      const cat = document.getElementById("categoryName").value;
      if (!storeData.categories[cat]) storeData.categories[cat] = {};
      await saveData();
      alert("Категория создана");
      loadData();
    }

    async function deleteCategory() {
      const cat = document.getElementById("categoryName").value;
      if (storeData.categories[cat]) {
        delete storeData.categories[cat];
        await saveData();
        alert("Категория удалена");
        loadData();
      } else {
        alert("Категория не найдена");
      }
    }

    async function addProduct() {
      const cat = document.getElementById("categoryName").value;
      const name = document.getElementById("productName").value;
      const price = parseInt(document.getElementById("productPrice").value);
      const stock = parseInt(document.getElementById("productStock").value);
      const desc = document.getElementById("productDesc").value;
      let specs;
      try { specs = JSON.parse(document.getElementById("productSpecs").value || "{}"); }
      catch { alert("Ошибка в JSON характеристик"); return; }

      if (!storeData.categories[cat]) storeData.categories[cat] = {};
      storeData.categories[cat][name] = { price, stock, description: desc, specs };
      await saveData();
      alert("Товар добавлен/обновлён");
      loadData();
    }

    async function deleteProduct() {
      const cat = document.getElementById("categoryName").value;
      const name = document.getElementById("productName").value;
      if (storeData.categories[cat] && storeData.categories[cat][name]) {
        delete storeData.categories[cat][name];
        // Если категория стала пустой, можно удалить её тоже
        if (Object.keys(storeData.categories[cat]).length === 0) {
          delete storeData.categories[cat];
        }
        await saveData();
        alert("Товар удалён");
        loadData();
      } else {
        alert("Товар не найден");
      }
    }

    async function saveData() {
      await fetch("/save_data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(storeData)
      });
    }

    // Дополнительные функции для улучшения UI
    function hideLoginPanel() {
      document.getElementById("loginPanel").classList.add("hidden");
    }

    function showUserInfo() {
      if (currentUser) {
        document.getElementById("balance").textContent = storeData.users[currentUser].balance;
        // Можно добавить отображение имени пользователя
        const userInfo = document.createElement("div");
        userInfo.innerHTML = `<p>Вы вошли как: ${currentUser}</p>`;
        document.body.prepend(userInfo);
      }
    }

    // Инициализация при загрузке страницы
    window.onload = function() {
      loadData();
      // Проверка, если пользователь уже вошел (можно сохранять в localStorage)
      const savedUser = localStorage.getItem("currentUser");
      if (savedUser && storeData.users[savedUser]) {
        currentUser = savedUser;
        hideLoginPanel();
        showUserInfo();
      }
    };

    // Функция выхода
    function logout() {
      currentUser = null;
      localStorage.removeItem("currentUser");
      document.getElementById("loginPanel").classList.remove("hidden");
      document.getElementById("balance").textContent = "0";
      alert("Вы вышли из системы");
    }

    // Добавляем кнопку выхода
    document.addEventListener("DOMContentLoaded", function() {
      const logoutBtn = document.createElement("button");
      logoutBtn.textContent = "Выйти";
      logoutBtn.onclick = logout;
      logoutBtn.style.margin = "10px";
      logoutBtn.style.padding = "5px 15px";
      document.body.appendChild(logoutBtn);
    });
  </script>
</body>
</html>