<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperShop - –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ú–∞–≥–∞–∑–∏–Ω</title>
    <style>
        /* ... –í–°–ï –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –ü–†–ï–ñ–ù–ò–ú–ò ... */
        /* (–≤—Å–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
        
        /* –î–û–ë–ê–í–õ–Ø–ï–ú –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–ò–ù–û–ö */
        .product-image-container {
            height: 200px;
            background: linear-gradient(45deg, var(--light), var(--gray));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-placeholder {
            font-size: 3rem;
            color: white;
        }
        
        .image-upload-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: var(--radius);
        }
    </style>
</head>
<body>
    <!-- –í–°–Ø –†–ê–ó–ú–ï–¢–ö–ê –û–°–¢–ê–ï–¢–°–Ø –ü–†–ï–ñ–ù–ï–ô -->
    <!-- (—à–∞–ø–∫–∞, —Ç–∞–±—ã, –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏ —Ç.–¥.) -->
    
    <!-- –î–û–ë–ê–í–õ–Ø–ï–ú –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø -->
    <div id="imageUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üñºÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                <button class="close-btn" onclick="closeImageUploadModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–¥–æ 1MB):</label>
                    <input type="file" class="form-control" id="imageFileInput" accept="image/*">
                </div>
                <div id="imagePreviewContainer" style="display: none;">
                    <p>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</p>
                    <img id="imagePreview" class="image-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                    <p id="imageInfo" style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="uploadProductImage()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                    <button class="btn btn-secondary" onclick="removeProductImage()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====================
        let storeData = {
            users: {},
            categories: {},
            orders: [],
            adminPassword: "log21",
            productImages: {} // –ù–û–í–û–ï: —Ö—Ä–∞–Ω–∏–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
        };
        
        let currentUser = null;
        let currentProduct = null;
        let isAdmin = false;
        let editingImageFor = null; // –î–ª—è –∫–∞–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Ç–æ–≤–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

        // ===================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–ê–†–¢–ò–ù–û–ö =====================
        function showImageUploadModal(category, productName) {
            editingImageFor = { category, productName };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const imageKey = `${category}|${productName}`;
            const existingImage = storeData.productImages?.[imageKey];
            
            if (existingImage) {
                document.getElementById('imagePreview').src = existingImage;
                document.getElementById('imagePreviewContainer').style.display = 'block';
                document.getElementById('imageInfo').textContent = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
            } else {
                document.getElementById('imagePreviewContainer').style.display = 'none';
            }
            
            // –û—á–∏—â–∞–µ–º input —Ñ–∞–π–ª–∞
            document.getElementById('imageFileInput').value = '';
            
            document.getElementById('imageUploadModal').classList.add('active');
        }

        function closeImageUploadModal() {
            document.getElementById('imageUploadModal').classList.remove('active');
            editingImageFor = null;
        }

        function previewImage() {
            const fileInput = document.getElementById('imageFileInput');
            const previewContainer = document.getElementById('imagePreviewContainer');
            const preview = document.getElementById('imagePreview');
            const info = document.getElementById('imageInfo');
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å–∏–º—É–º 1MB)
                if (file.size > 1024 * 1024) {
                    showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 1MB)', 'error');
                    fileInput.value = '';
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø
                if (!file.type.startsWith('image/')) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                    fileInput.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block';
                    info.textContent = `–†–∞–∑–º–µ—Ä: ${Math.round(file.size / 1024)}KB, –¢–∏–ø: ${file.type}`;
                };
                reader.readAsDataURL(file);
            }
        }

        async function uploadProductImage() {
            if (!editingImageFor) return;
            
            const fileInput = document.getElementById('imageFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning');
                return;
            }
            
            // –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ 100x100 –ø–∏–∫—Å–µ–ª–µ–π
            try {
                showNotification('–°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...', 'info');
                
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç img
                const img = new Image();
                img.onload = function() {
                    // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è —Å–∂–∞—Ç–∏—è
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä 100x100
                    canvas.width = 100;
                    canvas.height = 100;
                    
                    // –†–∏—Å—É–µ–º —Å–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    ctx.drawImage(img, 0, 0, 100, 100);
                    
                    // –ü–æ–ª—É—á–∞–µ–º base64 —Å—Ç—Ä–æ–∫—É
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ storeData
                    const imageKey = `${editingImageFor.category}|${editingImageFor.productName}`;
                    if (!storeData.productImages) storeData.productImages = {};
                    storeData.productImages[imageKey] = compressedBase64;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    save_data(storeData).then(() => {
                        showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (100x100)', 'success');
                        closeImageUploadModal();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                        if (document.getElementById('productsTab').classList.contains('active')) {
                            loadProducts();
                        }
                    });
                };
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ img
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
            }
        }

        async function removeProductImage() {
            if (!editingImageFor) return;
            
            const imageKey = `${editingImageFor.category}|${editingImageFor.productName}`;
            if (storeData.productImages && storeData.productImages[imageKey]) {
                delete storeData.productImages[imageKey];
                await save_data(storeData);
                showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
                closeImageUploadModal();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                if (document.getElementById('productsTab').classList.contains('active')) {
                    loadProducts();
                }
            } else {
                showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'warning');
            }
        }

        // ===================== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –¢–û–í–ê–†–û–í =====================
        function loadProducts() {
            const container = document.getElementById('productsContainer');
            
            if (!storeData.categories || Object.keys(storeData.categories).length === 0) {
                container.innerHTML = `
                    <div class="text-center">
                        <div style="font-size: 4rem; color: #ddd;">üõçÔ∏è</div>
                        <p style="margin-top: 20px; font-size: 1.2rem;">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="products-grid">';
            
            for (const [categoryName, category] of Object.entries(storeData.categories)) {
                for (const [productName, product] of Object.entries(category)) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–æ–≤–∞—Ä–∞
                    const imageKey = `${categoryName}|${productName}`;
                    const productImage = storeData.productImages?.[imageKey];
                    
                    html += `
                        <div class="product-card">
                            <div class="product-image-container">
                                ${productImage ? 
                                    `<img src="${productImage}" class="product-image" alt="${productName}">` : 
                                    `<div class="image-placeholder">üì¶</div>`
                                }
                                ${isAdmin ? `
                                    <button class="image-upload-btn" onclick="showImageUploadModal('${categoryName}', '${productName}')">
                                        üì∑
                                    </button>
                                ` : ''}
                            </div>
                            <div class="product-info">
                                <h3 class="product-title">${productName}</h3>
                                <p class="product-description">${product.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                                <div class="product-price">${product.price} ‚Ç¥</div>
                                <div class="product-meta">
                                    <div class="product-stock ${product.stock === 0 ? 'out' : ''}">
                                        ${product.stock === 0 ? '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' : `‚úÖ –í –Ω–∞–ª–∏—á–∏–∏: ${product.stock}`}
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="showProduct('${categoryName}', '${productName}')">
                                        üëÅÔ∏è –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ===================== –û–ë–ù–û–í–õ–ï–ù–ù–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –¢–û–í–ê–†–ê =====================
        function showProduct(category, name) {
            currentProduct = { category, name };
            const product = storeData.categories[category][name];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const imageKey = `${category}|${name}`;
            const productImage = storeData.productImages?.[imageKey];
            
            let modalHTML = `
                <div class="modal-header">
                    <h3>${name}</h3>
                    <button class="close-btn" onclick="closeProductModal()">√ó</button>
                </div>
                <div class="modal-body">
                    ${productImage ? `<img src="${productImage}" class="image-preview" alt="${name}" style="margin-bottom: 20px;">` : ''}
                    <div class="product-price">${product.price} ‚Ç¥</div>
                    <p>${product.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                    <div class="product-meta">
                        <div class="product-stock ${product.stock === 0 ? 'out' : ''}">
                            ${product.stock === 0 ? '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' : `‚úÖ –í –Ω–∞–ª–∏—á–∏–∏: ${product.stock} —à—Ç.`}
                        </div>
                        <button class="btn btn-primary" onclick="buyCurrentProduct()">üõí –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                    </div>
                </div>
            `;
            
            document.getElementById('productModal').innerHTML = modalHTML;
            document.getElementById('productModal').classList.add('active');
        }

        // ===================== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –¢–û–í–ê–†–ê (–∞–¥–º–∏–Ω) =====================
        async function saveProduct() {
            const category = document.getElementById('productCategorySelect').value;
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const description = document.getElementById('productDescription').value.trim();
            
            if (!name || isNaN(price) || isNaN(stock)) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'warning');
                return;
            }
            
            let actualCategory = category;
            
            if (category === "__new__") {
                actualCategory = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:');
                if (!actualCategory) return;
                if (!storeData.categories[actualCategory]) {
                    storeData.categories[actualCategory] = {};
                }
            } else if (!storeData.categories[category]) {
                storeData.categories[category] = {};
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–≤–∞—Ä
            storeData.categories[actualCategory][name] = {
                price: price,
                stock: stock,
                description: description,
                updatedAt: new Date().toISOString()
            };
            
            await save_data(storeData);
            loadAdminCategories();
            loadProducts();
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productDescription').value = '';
            
            showNotification('–¢–æ–≤–∞—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
        }

        // ===================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====================
        async function init() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            storeData = await get_data();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º productImages –µ—Å–ª–∏ –Ω–µ—Ç
            if (!storeData.productImages) {
                storeData.productImages = {};
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    currentUser = userData.username;
                    isAdmin = userData.isAdmin || false;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
            loadProducts();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            document.getElementById('imageFileInput').addEventListener('change', previewImage);
            
            console.log('‚úÖ –ú–∞–≥–∞–∑–∏–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
            showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SuperShop!', 'success');
        }

        // ===================== –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô =====================
        // (get_data, save_data, login, register, –∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∏–∑–º–µ–Ω–∏–ª–∏ –∏–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
